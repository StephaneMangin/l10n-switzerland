<?xml version="1.0" encoding="UTF-8"?>
<XML-FSCM-INVOICE-2013A>
  <INTERCHANGE>
    <IC-SENDER>
      <Pid>{{ client_pid }}</Pid>
    </IC-SENDER>
    <IC-RECEIVER>
      <Pid>41010106799303734</Pid>
    </IC-RECEIVER>
    <IC-Ref>{{ document_ref }}</IC-Ref>
  </INTERCHANGE>
  <INVOICE Type="${ document_type }">
    <HEADER>
      <FUNCTION-FLAGS>
        <Confirmation-Flag />
      </FUNCTION-FLAGS>
      <MESSAGE-REFERENCE>
        <REFERENCE-DATE>
          <Reference-No>{{ invoice.number }}</Reference-No>
          <Date>{{ format_date() }}</Date>
        </REFERENCE-DATE>
      </MESSAGE-REFERENCE>
      <PRINT-DATE>
        <Date>{{ format_date(invoice.date_invoice) }}</Date>
      </PRINT-DATE>
      <REFERENCE>
        <INVOICE-REFERENCE>
          <REFERENCE-DATE>
            <Reference-No>{{ invoice.number }}</Reference-No>
            <Date>{{ format_date(invoice.date_invoice) }}</Date>
          </REFERENCE-DATE>
        </INVOICE-REFERENCE>
      </REFERENCE>
      <BILLER>
        {%- if biller.vat %}
        <Tax-No>{{ biller.vat }}</Tax-No>
        {% endif %}
        <Doc-Reference>{{ invoice_esr }}</Doc-Reference>
        <PARTY-ID>
          <Pid>{{ biller.paynet_billerid }}</Pid>
        </PARTY-ID>
        <NAME-ADDRESS Format="COM">
          <NAME>
            <Line-35>{{ biller_address.name }}</Line-35>
          </NAME>
          <STREET>
            <Line-35>{{ biller_address.street }}</Line-35>
            biller_address.street2:
            <Line-35>{{ biller_address.street2 or '' }}</Line-35>
            %endif
          </STREET>
          <City>{{ biller_address.city }}</City>
          <Zip>{{ biller_address.zip }}</Zip>
          <Country>{{ biller_address.country_id.code or 'CH' }}</Country>
        </NAME-ADDRESS>
        <BANK-INFO>
          <Acct-No>{{ invoice_esr_bank }}</Acct-No>
          <BankId Type="BCNr-int" Country="CH">001996</BankId>
        </BANK-INFO>
      </BILLER>
      <PAYER>
        <PARTY-ID>
          <Pid>{{ ebill_account_number }}</Pid>
        </PARTY-ID>
        <NAME-ADDRESS Format="PRV">
          <NAME>
            <Line-35>{{ customer.name }}</Line-35>
          </NAME>
          <STREET>
            <Line-35>{{ customer_address.street }}</Line-35>
            %if customer_address.street2:
            <Line-35>{{ customer_address.street2 or '' }}</Line-35>
            %endif
          </STREET>
          <City>{{ customer_address.city }}</City>
          <Zip>{{ customer_address.zip }}</Zip>
          <Country>{{ customer_address.country_id.code or 'CH' }}</Country>
        </NAME-ADDRESS>
      </PAYER>
    </HEADER>
    <LINE-ITEM />
    <SUMMARY>
      <INVOICE-AMOUNT>
        <Amount Currency="CHF">{{ invoice.amount_total }}</Amount>
      </INVOICE-AMOUNT>
      <VAT-AMOUNT>
        <Amount Currency="CHF">{{ invoice.amount_tax }}</Amount>
      </VAT-AMOUNT>
      <EXTENDED-AMOUNT Type="79">
        <Amount Currency="CHF">{{ invoice.amount_untaxed }}</Amount>
      </EXTENDED-AMOUNT>
      {% if invoice.tax_line %}
      {% for taxline in invoice.tax_line %}
      <TAX>
        <TAX-BASIS>
          <Amount Currency="CHF">{{ taxline.base }}</Amount>
        </TAX-BASIS>
        {# Naive implementation. #}
        {# Openerp groups lines by base code, tax code and account, so in #}
        {# general we might have different tax rates per taxline. #}
      {% if taxline.base %}
      <Rate Category="S">{{ round(taxline.amount / taxline.base * 100, 2) }}</Rate>
      {% else %}
      <Rate Category="E">0</Rate>
      {% endif %}
      <Amount Currency="CHF">${ taxline.amount }</Amount>
    </TAX>
    {% endfor %}
    {% else %}
    <TAX>
      <TAX-BASIS>
        <Amount Currency="CHF">${ invoice.amount_untaxed }</Amount>
      </TAX-BASIS>
      <Rate Category="E">0</Rate>
      <Amount Currency="CHF">0</Amount>
    </TAX>
    {% endif %}
    <PAYMENT-TERMS>
      <BASIC Payment-Type="{{ payment_type }}" Terms-Type="5">
        <TERMS>
          <Date>{{ format_date(invoice.date_due or invoice.date_invoice) }}</Date>
        </TERMS>
      </BASIC>
    </PAYMENT-TERMS>
    <Back-Pack-Container Encode="Base64">
      {{ pdf_data }}
    </Back-Pack-Container>
  </SUMMARY>
</INVOICE>
</XML-FSCM-INVOICE-2013A>
